{% extends 'base.html' %} {% block content %}
<style>
  .scrollbar-thin::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }
  .ai-response-container {
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    position: relative;
    overflow: hidden;
  }

  .ai-response-container::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, #3b82f6, #8b5cf6);
    opacity: 0.6;
  }

  .ai-response-content {
    line-height: 1.7;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
      sans-serif;
  }

  .ai-response-content h1,
  .ai-response-content h2,
  .ai-response-content h3,
  .ai-response-content h4,
  .ai-response-content h5,
  .ai-response-content h6 {
    @apply text-gray-900 font-semibold mt-6 mb-3 leading-tight;
  }

  .ai-response-content h1 {
    @apply text-2xl border-b border-gray-200 pb-2;
  }
  .ai-response-content h2 {
    @apply text-xl;
  }
  .ai-response-content h3 {
    @apply text-lg;
  }
  .ai-response-content h4 {
    @apply text-base;
  }

  .ai-response-content p {
    @apply mb-4 text-justify;
  }

  .ai-response-content ul,
  .ai-response-content ol {
    @apply my-4 pl-6 space-y-2;
  }

  .ai-response-content ul li {
    @apply relative;
    list-style: none;
  }

  .ai-response-content ul li::before {
    content: "â€¢";
    @apply text-indigo-500 font-bold absolute -left-4;
  }

  .ai-response-content ol li {
    @apply relative;
    list-style: none;
    counter-increment: item;
  }

  .ai-response-content ol {
    counter-reset: item;
  }

  .ai-response-content ol li::before {
    content: counter(item) ".";
    @apply text-indigo-500 font-semibold absolute -left-6;
  }

  .ai-response-content blockquote {
    @apply border-l-4 border-indigo-400 bg-indigo-50 pl-4 py-3 my-4 italic text-gray-700;
  }

  .ai-response-content code {
    @apply bg-gray-100 text-red-600 px-2 py-1 rounded text-sm font-mono;
  }

  .ai-response-content pre {
    @apply bg-gray-900 text-gray-100 p-4 rounded-lg my-4 overflow-x-auto;
    position: relative;
  }

  .ai-response-content pre code {
    @apply bg-transparent text-gray-100 p-0;
  }

  .ai-response-content table {
    @apply w-full border-collapse my-4 bg-white rounded-lg overflow-hidden shadow-sm;
  }

  .ai-response-content th,
  .ai-response-content td {
    @apply px-4 py-3 text-left border-b border-gray-200;
  }

  .ai-response-content th {
    @apply bg-gray-50 font-semibold text-gray-900;
  }

  .ai-response-content tr:hover {
    @apply bg-gray-50;
  }

  .ai-response-content a {
    @apply text-indigo-600 hover:text-indigo-800 underline font-medium;
  }

  .ai-response-content strong {
    @apply text-gray-900 font-semibold;
  }

  .ai-response-content em {
    @apply text-gray-600 italic;
  }

  /* Copy button for code blocks */
  .code-block-container {
    position: relative;
  }

  .copy-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    @apply bg-gray-700 hover:bg-gray-600 text-white text-xs px-2 py-1 rounded opacity-0 transition-opacity;
  }

  .code-block-container:hover .copy-btn {
    opacity: 1;
  }
</style>
<input type="hidden" id="session-id" value="{{ session.id }}" />

<div class="flex h-[93.4vh] bg-gray-50">
 <!-- Sidebar -->
  <div class="w-[300px] bg-gray-900 text-white flex flex-col">
    <!-- Header -->
    <div class="p-4 border-b border-gray-700">
      <a href="{% url 'new_chat' %}">
        <button
          class="w-full bg-gray-800 hover:bg-gray-700 p-3 rounded-lg text-left transition duration-200 flex items-center"
        >
          <svg
            class="w-4 h-4 mr-3"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 6v6m0 0v6m0-6h6m-6 0H6"
            ></path>
          </svg>
          New Chat
        </button>
      </a>
    </div>
    <!-- Chat History -->
    <div
      id="session-list-container"
      class="flex-1 overflow-y-auto p-2 scrollbar-thin"
    >
      {% include 'gpt/session_list.html'%}
    </div>

    <!-- User Section -->
    <div class="p-4 border-t border-gray-700">
      <div class="flex items-center">
        <div
          class="w-8 h-8 bg-indigo-500 rounded-full flex items-center justify-center text-white text-sm font-semibold"
        >
          {{ user.first_name|default:user.username|first|upper }}
        </div>
        <div class="ml-3">
          <div class="text-sm font-medium">
            {{ user.get_full_name|default:user.username }}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Chat Area -->
  <div class="flex-1 flex flex-col">
    <!-- Messages Container -->
    <div class="flex-1 overflow-y-auto">
      <div class="max-w-4xl mx-auto h-full">
        <!-- Sample Messages -->
        <div id="chat-messages" class="px-4 pb-4 pt-4">
          {% for msg in messages %} {% if msg.role == 'user' %}
          <div class="flex justify-end mb-6">
            <div class="max-w-3xl">
              <div
                class="bg-indigo-900 text-white p-4 rounded-2xl rounded-br-md"
              >
                <p>{{ msg.content }}</p>
              </div>
              <div class="flex items-center justify-end mt-2">
                <span class="text-xs text-gray-500"
                  >You â€¢ {{ msg.created_at|date:"H:i" }}</span
                >
              </div>
            </div>
          </div>
          {% else %}

          <!-- Ai message -->
          <div class="flex justify-start mb-6">
            <div class="flex items-start max-w-3xl">
              <div
                class="w-8 h-8 bg-indigo-500 rounded-full flex items-center justify-center text-white text-sm font-semibold mr-3 mt-1 p-3"
              >
                AI
              </div>
              <div>
                <div
                  class="bg-white border border-gray-200 p-4 rounded-2xl rounded-bl-md shadow-sm ai-response-container"
                >
                  <div class="ai-response-content text-gray-800">
                    {{ msg.content|safe }}
                  </div>
                </div>
                <div class="flex items-center mt-2">
                  <span class="text-xs text-gray-500"
                    >GPT â€¢ {{ msg.created_at|date:"H:i" }}</span
                  >
                </div>
              </div>
            </div>
          </div>
          {% endif %} {% endfor %}
          <div id="loading-indicator" class="flex justify-start mb-6 hidden">
            <div class="flex items-start max-w-3xl">
              <div
                class="w-8 h-8 bg-indigo-500 rounded-full flex items-center justify-center text-white text-sm font-semibold mr-3 mt-1 p-3"
              >
                AI
              </div>
              <div
                class="bg-white border border-gray-200 p-4 rounded-2xl rounded-bl-md shadow-sm"
              >
                <p class="text-gray-500 italic animate-pulse">
                  Generating response...
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Input Area -->
    <div class="bg-white border-t border-gray-200 p-4">
      <div class="max-w-4xl mx-auto">
        <div class="relative">
          <textarea
            id="user-input"
            class="w-full p-4 pr-12 border border-gray-300 rounded-2xl resize-none focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            rows="1"
            placeholder="Message ChatGPT..."
            style="min-height: 75px; max-height: 200px"
            oninput="this.style.height = 'auto'; this.style.height = Math.min(this.scrollHeight, 200) + 'px';"
          ></textarea>
          <button
            id="send-btn"
            class="absolute right-3 bottom-3 w-8 h-8 bg-gray-200 hover:bg-gray-300 rounded-full flex items-center justify-center transition duration-200"
          >
            <svg
              class="w-4 h-4 text-gray-600"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"
              ></path>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<div
  id="deleteModal"
  class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden"
>
  <div
    class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-sm shadow-lg"
  >
    <h2 class="text-lg font-semibold text-black-900 dark:text-black-100 mb-4">
      Delete Chat?
    </h2>
    <p class="text-sm text-black-600 dark:text-black-300 mb-6">
      Are you sure you want to delete this chat session? This action cannot be
      undone.
    </p>
    <div class="flex justify-end space-x-3">
      <button
        onclick="closeModal()"
        class="px-4 py-2 rounded bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white hover:bg-gray-300 dark:hover:bg-gray-600 transition"
      >
        Cancel
      </button>
      <button
        id="confirmDeleteBtn"
        class="px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700 transition"
      >
        Delete
      </button>
    </div>
  </div>
</div>

<!-- script functions-->
<script>
  document.getElementById("send-btn").addEventListener("click", function () {
    const input = document.getElementById("user-input");
    const message = input.value.trim();
    if (!message) return;

    const chatBox = document.getElementById("chat-messages");
    chatBox.innerHTML += `
    <div class="flex justify-end mb-6">
      <div class="max-w-3xl">
        <div class="bg-indigo-900 text-white p-4 rounded-2xl rounded-br-md">
          <p>${message}</p>
        </div>
        <div class="flex items-center justify-end mt-2">
          <span class="text-xs text-gray-500">You â€¢ ${new Date().toLocaleTimeString(
            [],
            {
              hour: "2-digit",
              minute: "2-digit",
            }
          )}</span>
        </div>
      </div>
    </div>
  `;
    input.value = "";
    input.style.height = "auto";
    input.style.height = input.scrollHeight + "px";

    const sessionId = document.getElementById("session-id").value;
    const loadingIndicator = document.getElementById("loading-indicator");
    chatBox.appendChild(loadingIndicator);
    loadingIndicator.classList.remove("hidden");
    chatBox.scrollTop = chatBox.scrollHeight;

    fetch("/chat/send-message/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCookie("csrftoken"),
      },
      body: JSON.stringify({
        prompt: message,
        session_id: sessionId,
      }),
    })
      .then((res) => res.json())
      .then((data) => {
        // Update session ID if it was a new chat
        if (data.session_id) {
          document.getElementById("session-id").value = data.session_id;

          // ðŸ” Refresh the sidebar only AFTER session is saved
          fetch("/chat/get-sessions/")
            .then((res) => res.json())
            .then((data) => {
              document.getElementById("session-list-container").innerHTML =
                data.html;
            })
            .catch((err) => {
              console.error("Failed to refresh session list", err);
            });
        }

        document.getElementById("loading-indicator").classList.add("hidden");

        let contentHTML = `<div class="ai-response-content text-gray-800">${marked.parse(
          data.reply
        )}</div>`;

        if (data.download_url) {
          const urlParts = data.download_url.split("/");
          const fileName = urlParts[urlParts.length - 1];
          const fileExt = fileName.split(".").pop().toLowerCase();
          let icon = "";

          if (fileExt === "pdf") icon = "ðŸ“„";
          else if (fileExt === "pptx" || fileExt === "ppt") icon = "ðŸ“Š";

          contentHTML += `
          <div class="mt-4 p-3 bg-gray-50 rounded-lg border border-gray-200">
            <div class="flex items-center space-x-2">
              <span class="text-xl">${icon}</span>
              <a href="${data.download_url}" class="text-indigo-600 hover:text-indigo-800 underline font-medium" download>${fileName}</a>
            </div>
          </div>`;
        }

        chatBox.innerHTML += `
        <div class="flex justify-start mb-6">
          <div class="flex items-start max-w-3xl">
            <div class="w-8 h-8 bg-indigo-500 rounded-full flex items-center justify-center text-white text-sm font-semibold mr-3 mt-1 p-3">
              AI
            </div>
            <div>
              <div class="bg-white border border-gray-200 p-4 rounded-2xl rounded-bl-md shadow-sm ai-response-container">
                ${contentHTML}
              </div>
              <div class="flex items-center mt-2">
                <span class="text-xs text-gray-500">GPT â€¢ ${new Date().toLocaleTimeString(
                  [],
                  {
                    hour: "2-digit",
                    minute: "2-digit",
                  }
                )}</span>

              </div>
            </div>
          </div>
        </div>
      `;

        chatBox.scrollTop = chatBox.scrollHeight;
      })
      .catch((err) => {
        document.getElementById("loading-indicator").classList.add("hidden");
        alert("Something went wrong.");
        console.error(err);
      });
  });

  document
    .getElementById("user-input")
    .addEventListener("keydown", function (e) {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();

        document.getElementById("send-btn").click();
      }
    });

  // CSRF helper
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === name + "=") {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  // Delete chat function
  let deleteSessionId = null;
  function deleteChat(sessionId) {
    deleteSessionId = sessionId;
    document.getElementById("deleteModal").classList.remove("hidden");
  }

  function closeModal() {
    deleteSessionId = null;
    document.getElementById("deleteModal").classList.add("hidden");
  }

  document.getElementById("confirmDeleteBtn").addEventListener("click", () => {
    if (!deleteSessionId) return;

    fetch("/chat/delete-session/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCookie("csrftoken"),
      },
      body: JSON.stringify({ session_id: deleteSessionId }),
    })
      .then((res) => res.json())
      .then((data) => {
        closeModal();
        if (data.success) {
          location.reload();
        } else {
          alert("Error deleting chat.");
        }
      })
      .catch((err) => {
        console.error("Delete failed:", err);
        alert("Something went wrong.");
      });
  });
</script>

{% endblock %}
